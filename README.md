# vk-io
###Russian
Модуль для лёгкой и удобной работы с vk api!

## npm зависимости
* async
* base-io
* cheerio
* bluebird
* html-entities
* request-promise

## Использование
#### Инициализация
```javascript
'use strict';

let vk = new (require('vk-io'));
```
#### Конфигурация
```javascript
vk.setting({
  id: 'ID пользователя',
  email: 'Логин/email/телефон пользователя',
  token: 'Токен пользователя',
  app: 'Приложение standlone',
  key: 'Секретный ключ приложения',
  limit: 3 /* Лучше оставить как есть если у вас он не выше 3 */
});
```
#### Авторизация вк для полного токена
```javascript
vk.setting({
  app: 114,
  email: 'user@example.com',
  pass: '1234'
});

vk.auth()
.then((token) => {
  /* Дальше например сохраняете токен, он так же обновится в настройках */
})
```
#### Выполнение методов вк
Достаточно скопировать название метода [api methods.](https://vk.com/dev/methods) на примере `messages.get`
```javascript
vk.api.messages.get({
  count: 5
})
.then((messages) => {
  /* Работаем с данными */
});
```
#### Работа с longpoll
Список евентов `.on` начинается с `longpoll.[название]`  
Метод `longpoll` возвращает promise, после него не повесить обработчик `.on`, учтите это.
```javascript
vk.longpoll();

vk.on('longpoll.message',(msg) => {
	/* Действия с сообщением */
});
```
###### Список евентов longpoll
| Название              | Описание                                                                                                                                                                                                                                                        | Данные                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
|-----------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| message.delete        | Удаление сообщения с указанным local id                                                                                                                                                                                                                         | `id` - id сообщения , `local` - удаляемое сообщения.                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| message.flags.replace | Замена флагов сообщения                                                                                                                                                                                                                                         | `id` - id сообщения , `flags` - флаги сообщения.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| message.flags.set     | Установка флагов сообщения                                                                                                                                                                                                                                      | `id` - id сообщения , `flags` - флаги сообщения.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| message.flags.reset   | Cброс флагов сообщения                                                                                                                                                                                                                                          | `id` - id сообщения , `flags` - флаги сообщения.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| message               | Получение нового сообщения                                                                                                                                                                                                                                      | `id` - id сообщения, `flags` - флаги сообщения, `peer` -идентификатор назначения, `user` - id пользователя, `date` - timestamp сообщения, `title` - название беседы, `text` - текст сообщения, `attach` - прикрепления, `isChat` - написано сообщение в чате, `chat` - id чата. В `attach` возможные прикрепления, `fwd` - пересылаемые сообщения, `wall` - стенка, `photo` - фотографии, `video` - видеозаписи, 'audio' - аудиозаписи, `doc` - документы, `sticker` - стикер, `link` - ссылка, `emoji` - присутвуют ли стикеры. |
| message.read.inbox    | Прочтение всех входящих сообщений с $peer_id вплоть до $local_id                                                                                                                                                                                                | `peer` - id начального, `local` - конечное id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| message.read.outbox   | Прочтение всех исходящих сообщений с $peer_id вплоть до $local_id                                                                                                                                                                                               | `peer` - id начального, `local` - конечное id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| user.online           | Друг $user_id стал онлайн                                                                                                                                                                                                                                       | `user` - id пользователя, `flags` - флаги сообщения                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| user.offline          | Друг $user_id стал оффлайн                                                                                                                                                                                                                                      | `user` - id пользователя, `flags` - флаги сообщения                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| chat.flags.reset      | Сброс флагов фильтрации по папкам для чата/собеседника с $peer_id                                                                                                                                                                                               | `peer` - идентификатор чата, `flags` - флаги сообщения                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| chat.flags.replace    | Замена флагов фильтрации по папкам для чата/собеседника с $peer_id.                                                                                                                                                                                             | `peer` - идентификатор чата, `flags` - флаги сообщения                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| chat.flags.set        | Установка флагов фильтрации по папкам для чата/собеседника с $peer_id                                                                                                                                                                                           | `peer` - идентификатор чата, `flags` - флаги сообщения                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| message.replace.flags | Замена флагов всех сообщений с заданным peer_id (применяется только к сообщениям, у которых на текущий момент не установлены флаги 128 (deleted) и 64 (spam))                                                                                                   | `peer` - идентификатор чата, `flags` - флаги сообщения                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| message.set.flags     | Установка флагов всех сообщений с заданным peer_id (FLAGS|=$mask) (применяется только к сообщениям, у которых на текущий момент не установлены флаги 128 (deleted) и 64 (spam))                                                                                 | `peer` - идентификатор чата, `flags` - флаги сообщения                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| message.reset.flags   | Сброс флагов всех сообщений с заданным peer_id (FLAGS&=~$mask) (применяется только к сообщениям, у которых на текущий момент не установлены флаги 128 (deleted) и 64 (spam))                                                                                    | `peer` - идентификатор чата, `flags` - флаги сообщения                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| chat.action           | Один из параметров (состав, тема) беседы $chat_id были изменены. $self - были ли изменения вызваны самим пользователем                                                                                                                                          | `chat` - id чата, `self` - вызваны ли они самим пользователем (boolean)                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| user.active.message   | Пользователь $user_id начал набирать текст в диалоге. событие должно приходить раз в ~5 секунд при постоянном наборе текста                                                                                                                                     | `user` - id пользователя, `flags` - флаги                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| user.active.chat      | Пользователь $user_id начал набирать текст в беседе $chat_id.                                                                                                                                                                                                   | `user` - id пользователя, `chat` - id чата                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| user.call             | Пользователь $user_id совершил звонок имеющий идентификатор $call_id.                                                                                                                                                                                           | `user` - id пользователя, `call` - id звонка                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| message.count         | Новый счетчик непрочитанных в левом меню стал равен $count.                                                                                                                                                                                                     | `count` - счётчик непрочитанных                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| email.send            | Сейчас оно используется только при отправке исходящего сообщения на e-mail.                                                                                                                                                                                     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| notify.set            | Изменились настройки оповещений, где peerId — $peer_id чата/собеседника, sound — 1 || 0, включены/выключены звуковые оповещения, disabled_until — выключение оповещений на необходимый срок (-1: навсегда, 0: включены, other: timestamp, когда нужно включить) | `peer` - идентификатор диалога, `sound` - включено ли оповоещение (boolean), `until` - срок включения                                                                                                                                                                                                                                                                                                                                                                                                                            |
#### Работа с потоками
Работает с теми методами в которых есть `offset`. Например `photos.get`
```javascript
vk.stream.photos.get({
  owner_id: 1,
  album_id: 136592355
})
.then((photos) => {
  /* Вернёт массив с данными */
});
```
#### Загрузка на сервера вк
На примере загружается картинка в диалог.
Остальные методы можно глянут в файле vk-io/include/upload.js
```javascript
vk.upload.message({
  file: __dirname+'/test.png'
})
.then((image) => {
  /* Возвращается объект photo */
});
```
#### Обработка исключений
Капча.
```javascript
vk.on('captcha',(captcha) => {
  /* Дальше пример, он может отличаться от того что вы будете использовать */
  /* Использовался модуль https://www.npmjs.com/package/ac-io */
  ac.url(captcha.src)
  .then((data) => {
  	captcha.handler(data.code);
  });
});
```
* `captcha.src` - путь до капчи
* `captcha.sid` - id капчи
* `captcha.handler` - нужно вызвать с передачей кода с капчи

#### Получение информации о состояние модуля
```javascript
var status = vk.status;
```
* `status.errors` - кол-во ошибок
* `status.execute` - кол-во выполненных методов vk
* `status.tasks.queue.length` - кол-во заданий в очереди
* `status.outbox` - кол-во отправленных сообщений
* `status.inbox` - кол-во принятых сообщений

Остальные ошибки можно отловить через `.catch()` с возвращаемого promise.

## TODO
* Если есть предложение пишите мне сюда [ВК](https://vk.com/id195624402)
